---
title: "MIB for Law Enforcement - Setting up Combined Sample"
author: "Dr. Calvin Lai"
date: "07/03/2021"
output:
  html_document: default
  pdf_document: default
  word_document: default
always_allow_html: yes
---

```{r setup, include = FALSE}
# Package names
packages <- c("sjPlot",  "psych", "foreign", "tidyverse", "glue", "effsize", "cowplot", "lme4", "lmerTest", "corrplot", "summarytools")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
rm(list = c("packages", "installed_packages"))

#Data to load 
t1 <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_t1-clean.csv", guess_max = min(12000))
t2 <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_t2-clean.csv", guess_max = min(12000))
t3 <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_t3-clean.csv", guess_max = min(12000))

t1t2 <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_t1t2-clean.csv", guess_max = min(12000))
t1t3 <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_t1t3-clean.csv", guess_max = min(12000))
t2t3 <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_t2t3-clean.csv", guess_max = min(12000))
all <- read_csv("C:/Users/Calvin/Documents/Dropbox/Projects/mib/data/mibstudy2_all-clean.csv", guess_max = min(12000))

# Creating long data for long analyses: All time points
timePivot <- function(data){
  data %>%  pivot_longer(
             cols = ends_with(c("t1", "t2", "t3")), 
             names_to=(c(".value", "time")), names_sep = ".t(?=\\d)") %>%
             select(id, time, everything())
}

allLong <- all %>% select(id, 
                          knowledge.t1, theories.t1, strategy_use, biasworry.t1, 
                          knowledge.t2, theories.t2, biasworry.t2, 
                          strategy_intend, strat_know.t2, strat_efficacy.t2, strat_mot.t2, 
                          knowledge.t3, theories.t3, biasworry.t3, 
                          strategy_used, strat_know.t3, strat_efficacy.t3, strat_mot.t3,                           
                          frequency_black, frequency_hispanic, frequency_asian,
                          frequency_gay, frequency_trans,
                          respect, centrality, yearsworked, rank,  
                          race_white, race_black, gender_d, education_ba,
                          attendance, facilduo_gender, facilduo_race, 
                          facilduo_le, facilduo_relatedle, facilduo_relatedle_nole) %>% 
                          dplyr::rename(strategy.t1 = strategy_use, 
                                 strategy.t2 = strategy_intend,
                                 strategy.t3 = strategy_used)

allLongKnowledgeT1 <- allLong %>% dplyr::rename(knowledge = knowledge.t1) %>% 
  select(c(-knowledge.t2, -knowledge.t3)) %>% timePivot()
                        
allLongTheoriesT1 <- allLong %>% dplyr::rename(theories = theories.t1) %>% 
  select(c(-theories.t2, -theories.t3)) %>% timePivot()

allLongBiasworryT1 <- allLong %>% dplyr::rename(biasworry = biasworry.t1) %>% 
  select(c(-biasworry.t2, -biasworry.t3)) %>% timePivot()                                            

allLong <- allLong %>% timePivot()
  
# Creating long data for long analyses: T1 + T2
t1t2Long <- t1t2 %>% select(id, 
                          knowledge.t1, theories.t1, strategy_use, biasworry.t1, 
                          knowledge.t2, theories.t2, biasworry.t2, 
                          strategy_intend, strat_know.t2, strat_efficacy.t2, strat_mot.t2, 
                          frequency_black, frequency_hispanic, frequency_asian,
                          frequency_gay, frequency_trans,
                          respect, centrality, yearsworked, rank,  
                          race_white, race_black, gender_d, education_ba,
                          attendance, facilduo_gender, facilduo_race, 
                          facilduo_le, facilduo_relatedle, facilduo_relatedle_nole) %>% 
                          dplyr::rename(strategy.t1 = strategy_use, 
                                 strategy.t2 = strategy_intend)

t1t2LongKnowledgeT1 <- t1t2Long %>% dplyr::rename(knowledge = knowledge.t1) %>% 
  select(c(-knowledge.t2)) %>% timePivot()
                        
t1t2LongTheoriesT1 <- t1t2Long %>% dplyr::rename(theories = theories.t1) %>% 
  select(c(-theories.t2)) %>% timePivot()

t1t2LongBiasworryT1 <- t1t2Long %>% dplyr::rename(biasworry = biasworry.t1) %>% 
  select(c(-biasworry.t2)) %>% timePivot()          

t1t2Long <- t1t2Long %>% timePivot()
 
# Creating long data for long analyses: T1 + T3
t1t3Long <- t1t3 %>% select(id, 
                          knowledge.t1, theories.t1, strategy_use, biasworry.t1, 
                          knowledge.t3, theories.t3, biasworry.t3, 
                          strategy_used, strat_know.t3, strat_efficacy.t3, strat_mot.t3,                           
                          substitution_use, substitution_used, 
                          perspective_use, perspective_used,
                          exposure_use, exposure_used,
                          individuation_use, individuation_used,
                          mindful_use, mindful_used,
                          frequency_black, frequency_hispanic, frequency_asian,
                          frequency_gay, frequency_trans,
                          respect, centrality, yearsworked, rank,  
                          race_white, race_black, gender_d) %>% 
                          dplyr::rename(
                                 strategy.t1 = strategy_use, strategy.t3 = strategy_used,
                                 substitution.t1 = substitution_use, substitution.t3 = substitution_used,
                                 perspective.t1 = perspective_use, perspective.t3 = perspective_used,
                                 exposure.t1 = exposure_use, exposure.t3 = exposure_used,
                                 individuation.t1 = individuation_use, individuation.t3 = individuation_used,
                                 mindful.t1 = mindful_use, mindful.t3 = mindful_used,
                                 strat_know = strat_know.t3, 
                                 strat_efficacy = strat_efficacy.t3, strat_mot = strat_mot.t3
                                 )

t1t3Long <- t1t3Long %>% timePivot()

# Creating long data for long analyses: T2 + T3
t2t3Long <- t2t3 %>% select(id, 
                          knowledge.t2, theories.t2, biasworry.t2, 
                          strategy_intend, strat_know.t2, strat_efficacy.t2, strat_mot.t2, 
                          knowledge.t3, theories.t3, biasworry.t3, 
                          strategy_used, strat_know.t3, strat_efficacy.t3, strat_mot.t3,                           
                          attendance, facilduo_gender, facilduo_race, 
                          facilduo_le, facilduo_relatedle, facilduo_relatedle_nole) %>% 
                          dplyr::rename(strategy.t2 = strategy_intend,
                                 strategy.t3 = strategy_used)

t2t3Long <- t2t3Long %>% timePivot()

# Creating cohen d round function
cohensd <- function(group1, group2){
  round(effsize::cohen.d(group2, group1, na.rm = T)$estimate, 2)
}

# Creating datasets for assessing differential attrition
# extra yearsworked at the end, but it doesn't matter. Didn't fix since it didn't cause problems
t1_no_t1t2 <- anti_join(t1, t1t2, by = "id") %>% select(knowledge.t1, theories.t1, biasworry.t1, respect, centrality, strategy_use,
                         frequency_black, frequency_asian, frequency_hispanic, frequency_gay, frequency_trans, yearsworked, race_white, race_black, gender_d, rank, yearsworked)
t1_no_t1t3 <- anti_join(t1, t1t3, by = "id") %>% select(knowledge.t1, theories.t1, biasworry.t1, respect, centrality, strategy_use,
                         frequency_black, frequency_asian, frequency_hispanic, frequency_gay, frequency_trans, yearsworked, race_white, race_black, gender_d, rank, yearsworked)
t1_no_all <- anti_join(t1, all, by = "id") %>% select(knowledge.t1, theories.t1, biasworry.t1, respect, centrality, strategy_use,
                         frequency_black, frequency_asian, frequency_hispanic, frequency_gay, frequency_trans, yearsworked, race_white, race_black, gender_d, rank, yearsworked)
temp_t1t2 <- t1t2 %>% select(knowledge.t1, theories.t1, biasworry.t1, respect, centrality, strategy_use,
                         frequency_black, frequency_asian, frequency_hispanic, frequency_gay, frequency_trans, yearsworked, race_white, race_black, gender_d, rank, yearsworked)
temp_t1t3 <- t1t3 %>% select(knowledge.t1, theories.t1, biasworry.t1, respect, centrality, strategy_use,
                         frequency_black, frequency_asian, frequency_hispanic, frequency_gay, frequency_trans, yearsworked, race_white, race_black, gender_d, rank, yearsworked)
temp_all <- all %>% select(knowledge.t1, theories.t1, biasworry.t1, respect, centrality, strategy_use,
                         frequency_black, frequency_asian, frequency_hispanic, frequency_gay, frequency_trans, yearsworked, race_white, race_black, gender_d, rank, yearsworked)

# Creating function for checking differential attrition
attritionCheck <- function(group1, group2) {
  output <- data.frame(nrow(length(group1)), ncol(8))
  for(i in 1:length(group1)) {
    output[i, 1] <- names(group1[i]) # Variable name
    output[i, 2] <- cohensd(group1[[i]], group2[[i]]) # Cohen's d
    output[i, 3] <- t.test(group1[i], group2[i])[3] # p-value
    output[i, 3] <- round(as.numeric(output[i, 3]), 4)
    output[i, 4] <- round(mean(group1[[i]], na.rm = T), 2) # m1
    output[i, 5] <- round(mean(group2[[i]], na.rm = T), 2) # m2
    output[i, 6] <- round(sd(group1[[i]], na.rm = T), 2) # sd1
    output[i, 7] <- round(sd(group2[[i]], na.rm = T), 2) # sd2
    output[i, 8] <- if_else(as.numeric(output[i, 3]) < .05, "*", "")
}
colnames(output) <- c("variable", "cohens d", "p-value", "m1", "m2", "sd1", "sd2", "sig")
output  
}
```


### Participants, Combined Sample

Participants were sworn officers of a police department or departments within the United States who took part in a training session between September 2020 and January 2021. We collected `r dim(t1)[1]` surveys from Time 1  (average of 66 days before  training; range = 1 to 144 days), `r dim(t2)[1]` surveys from Time 2 (end of the day, after the training session), and `r dim(t3)[1]` surveys from Time 3 (average of 32 days after training; range = 32 to 48 days). 

Participants had worked an average of `r round(mean(t1t2$yearsworked, na.rm=T), 0)` years in the department, with `r round((prop.table(table(t1t2$yearsworked_5y))[2]) * 100, 0)`% having worked in the department for 5 years or more. `r round(prop.table(table(t1t2$rank))[1] * 100, 0)`% of participants were below Sergeant rank, `r round(prop.table(table(t1t2$gender_d))[2] * 100, 0)`% were male, and `r round(prop.table(table(t1t2$education_ba))[2] * 100, 0)`% had a bachelor's degree or higher. Of the `r round(prop.table(table(is.na(t1t2$race)))[1] * 100, 0)`% participants that reported their race, `r round((prop.table(table(t1t2$race))[1]) * 100, 0)`% were White, `r round((prop.table(table(t1t2$race))[2]) * 100, 0)`% were Black, `r round((prop.table(table(t1t2$race))[3]) * 100, 0)`% were Hispanic/Latino, `r round((prop.table(table(t1t2$race))[4]) * 100, 0)`% were Asian, and `r round((prop.table(table(t1t2$race))[5]) * 100, 0)`% were multi-racial.

### Baseline characteristics, Combined Sample
```{r baseline statistics, echo=F, warning=F, message=F}
freq(t1t2$frequency_white)
freq(t1t2$frequency_black)
freq(t1t2$frequency_hispanic)
freq(t1t2$frequency_asian)
freq(t1t2$frequency_trans)
freq(t1t2$frequency_gay)

# NOTE: Cohen's d and t-tests were not used in reporting.
# Knowledge
t.test(t1t2$knowledge.t1, mu = 1)
sd(t1t2$knowledge.t1,na.rm=T)
effsize::cohen.d(t1t2$knowledge.t1, f = NA, mu =1, na.rm = T)
freq(t1t2$knowledge.t1)

# Concern
t.test(t1t2$biasworry.t1, mu = 1)
sd(t1t2$biasworry.t1,na.rm=T)
effsize::cohen.d(t1t2$biasworry.t1, f = NA, mu =1, na.rm = T)
freq(t1t2$biasworry.t1)

# Strategy Use
t.test(t1t2$strategy_use)
sd(t1t2$strategy_use,na.rm=T)
effsize::cohen.d(t1t2$strategy_use, f = NA, mu =0, na.rm = T)
freq(t1t2$strategy_use)

freq(t1t2$perspective_use)
freq(t1t2$mindful_use)
freq(t1t2$substitution_use)
freq(t1t2$exposure_use)
freq(t1t2$individuation_use)



# Internal survey calculations

# 1)	Whether the facilitators were knowledgeable, credible, and engaging on a scale from 1 (Strongly agree) to 7 (Strongly disagree). 
psych::m2t(1.35,1.70,.78,1.09,n1=3629,n2=2103) 
t2d(14.09422,n1=3629,n2=2103)

# 5)	Whether officers would use information from the workshop in their work or personal life on a scale from 1 (Strongly agree) to 7 (Strongly disagree). 
psych::m2t(1.95, 2.26,1.29,1.45,n1=3626,n2=2103) 
t2d(8.37,n1=3626,n2=2103)
```

### General perceptions of bias, Combined Sample
```{r Combined Sample  General perceptions of bias, echo=F, warning=F, message=F}
lmer.null <- summary(lmer(knowledge ~ (1|id), data = t1t2Long))

anova(lmer(knowledge ~ time + (1|id), data = t1t2Long), lmer.null)
summary(lmer(knowledge ~ time + (1|id), data = t1t2Long))
effsize::cohen.d(t1t2$knowledge.t2, t1t2$knowledge.t1, paired=T, na.rm = T)

summary(lmer(biasworry ~ time + (1|id), data = t1t2Long))
effsize::cohen.d(t1t2$biasworry.t2, t1t2$biasworry.t1, paired=T, na.rm = T)

summary(lmer(theories ~ time + (1|id), data = t1t2Long))
effsize::cohen.d(t1t2$theories.t2, t1t2$theories.t1, paired=T, na.rm = T)

```

### Strategies to manage bias, Combined Sample
```{r Combined Sample  strategies to manage bias, echo=F, warning=F, message=F}
# know
t.test(t1t2$strat_know.t2, mu = 1)
sd(t1t2$strat_know.t2,na.rm=T)
effsize::cohen.d(t1t2$strat_know.t2, f = NA, mu =1, na.rm = T)
freq(t1t2$strat_know.t2)

# Efficacy
t.test(t1t2$strat_efficacy.t2, mu = 1)
sd(t1t2$strat_efficacy.t2,na.rm=T)
effsize::cohen.d(t1t2$strat_efficacy.t2, f = NA, mu =1, na.rm = T)
freq(t1t2$strat_efficacy.t2)

# Motivation
t.test(t1t2$strat_mot.t2, mu = 1)
sd(t1t2$strat_mot.t2,na.rm=T)
effsize::cohen.d(t1t2$strat_mot.t2, f = NA, mu =1, na.rm = T)
freq(t1t2$strat_mot.t2)

# Strategy intentions
summary(lmer(strategy ~ time + (1|id), data = t1t2Long))
effsize::cohen.d(t1t2$strategy_intend, t1t2$strategy_use, paired=T, na.rm = T)
mean(t1t2$strategy_intend,na.rm=T)
```


